<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Сканер QR — СБП</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root{
            --bg:#0d1117;
            --card:#0f1720;
            --muted:#9fb0cc;
            --accent:#3aa0ff;
            --glass: rgba(255,255,255,0.03);
        }
        html,body{height:100%;margin:0}
        body{
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg,var(--bg) 0%, #081018 100%);
            color:#e6eef8;
            display:flex;align-items:center;justify-content:center;padding:24px
        }
        .card{
            width:100%;max-width:420px;background:linear-gradient(180deg,var(--card), #091019);
            border-radius:16px;padding:28px;box-shadow:0 8px 30px rgba(2,6,23,0.6);text-align:center
        }
        h1{margin:0 0 8px;font-size:18px;font-weight:600}
        p.lead{margin:0 0 18px;color:var(--muted);font-size:13px}

        /* Scanner visual */
        .scanner{
            width:220px;height:220px;margin:0 auto 18px;position:relative;border-radius:50%;
            background:radial-gradient(circle at 35% 30%, rgba(58,160,255,0.06), transparent 30%), var(--glass);
            display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.03)
        }
        .ring{position:absolute;inset:0;border-radius:50%;box-shadow:0 0 0 6px rgba(58,160,255,0.03) inset}
        .scan-line{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg, transparent, var(--accent), transparent);
            animation:scan 2s linear infinite;opacity:0.95}
        @keyframes scan{0%{top:10%}50%{top:90%}100%{top:10%}}
        .dot{width:14px;height:14px;border-radius:50%;background:linear-gradient(180deg,var(--accent),#006fbf);box-shadow:0 6px 18px rgba(58,160,255,0.18)}

        .btn{
            display:inline-flex;align-items:center;gap:10px;padding:12px 20px;border-radius:999px;background:linear-gradient(90deg,var(--accent),#2179d6);color:#fff;border:none;cursor:pointer;font-weight:600;box-shadow:0 8px 18px rgba(33,121,214,0.24)}
        .btn:active{transform:translateY(1px)}

        .note{margin-top:14px;font-size:12px;color:var(--muted)}

        /* small responsive tweaks */
        @media (max-width:420px){.scanner{width:180px;height:180px}}
    </style>
</head>
<body>
        <div class="card">
            <h1 id="title">Сканер QR СБП</h1>
            <p class="lead" id="subtitle">Нажмите кнопку и используйте встроенный сканер Telegram для чтения QR‑ссылки СБП.</p>

            <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:14px;">
                <div style="text-align:left;font-size:13px;color:var(--muted)">
                    <div>Курс: <b id="rate">—</b> RUB / USDT</div>
                    <div>Комиссия: <b id="commission">—</b>%</div>
                    <div>Баланс: <b id="balance">—</b> USDT</div>
                </div>
            </div>

            <div class="scanner" aria-hidden="true">
                <div class="ring"></div>
                <div class="scan-line"></div>
                <div class="dot"></div>
            </div>

            <div>
                <button class="btn" id="scanBtn">Отсканировать QR</button>
            </div>

            <div id="afterScan" style="display:none;margin-top:16px;">
                <div style="margin-bottom:8px;text-align:left">
                    <div style="font-size:13px;color:var(--muted)">Где: <b id="merchant">—</b></div>
                    <div style="font-size:13px;color:var(--muted)">QR: <span id="qr_text" style="word-break:break-all;color:#cfe9ff"></span></div>
                </div>
                <div style="margin:8px 0;display:flex;gap:8px;align-items:center;justify-content:center">
                    <input id="amountInput" type="number" min="1" step="0.01" placeholder="Сумма в RUB" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;width:160px;text-align:center">
                    <div style="font-size:13px;color:var(--muted)">≈ <span id="costUsdt">0.00</span> USDT</div>
                </div>
                <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
                    <button class="btn" id="sendBtn">Отправить на оплату</button>
                    <button class="btn" id="cancelBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Отмена</button>
                </div>
            </div>

            <div class="note" id="status">Примечание: откройте эту страницу внутри Telegram Web App для полного функционала.</div>
        </div>

    <script>
        // Safe Telegram wrapper
        const statusEl = document.getElementById('status');
        const scanBtn = document.getElementById('scanBtn');

        function getTelegram(){
            try{return window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null}catch(e){return null}
        }

        function setStatus(t){ statusEl.textContent = t }

            // parse incoming query params for rate/commission/balance
            const params = new URLSearchParams(window.location.search)
            const RATE = parseFloat(params.get('rate')) || 0
            const COMMISSION = parseFloat(params.get('commission')) || 0
            const BALANCE = parseFloat(params.get('balance')) || 0

            document.getElementById('rate').textContent = RATE.toFixed(2)
            document.getElementById('commission').textContent = COMMISSION.toFixed(1)
            document.getElementById('balance').textContent = BALANCE.toFixed(2)

                // render history if provided
                try{
                    const histB64 = params.get('history')
                    if(histB64){
                        const jsonStr = decodeURIComponent(escape(window.atob(histB64.replace(/-/g,'+').replace(/_/g,'/'))))
                        const items = JSON.parse(jsonStr)
                        const cont = document.createElement('div')
                        cont.style.marginTop = '12px'
                        cont.style.textAlign = 'left'
                        cont.innerHTML = '<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Последние операции:</div>'
                        items.forEach(it=>{
                            const d = document.createElement('div')
                            d.style.fontSize='13px'
                            d.style.color='var(--muted)'
                            const ts = new Date(it.ts).toLocaleString()
                            const sign = it.amount>0?'+':'-'
                            d.innerHTML = `${ts} — <b style="color:#cfe9ff">${it.type}</b> ${sign}${Math.abs(it.amount).toFixed(2)} USDT` + (it.meta && it.meta.merchant? ` — ${it.meta.merchant}` : '')
                            cont.appendChild(d)
                        })
                        document.querySelector('.card').appendChild(cont)
                    }
                }catch(e){ console.warn('history parse failed', e) }

            async function startScan(){
                const tg = getTelegram();
                if(!tg){ setStatus('Откройте этот Web App внутри Telegram для сканирования QR.'); return }

                setStatus('Ожидание сканирования...')
                try{ tg.ready() }catch(e){}

                tg.showScanQrPopup({ text: 'Наведите камеру на СБП QR‑код' }, function(text){
                    try{ tg.closeScanQrPopup() }catch(e){}
                    if(text){
                        onScanned(text)
                    } else {
                        setStatus('QR‑код не распознан. Попробуйте ещё раз.')
                    }
                })
            }

            function onScanned(text){
                // Show scanned data, allow entering purchase amount (if not present)
                document.getElementById('qr_text').textContent = text
                // guess merchant from URL host
                try{ const u = new URL(text); document.getElementById('merchant').textContent = u.hostname }catch(e){ document.getElementById('merchant').textContent = 'магазин' }

                // show form
                document.getElementById('afterScan').style.display = 'block'
                setStatus('Введите сумму покупки и нажмите Отправить на оплату')
                // compute cost on input
                const amountInput = document.getElementById('amountInput')
                const costEl = document.getElementById('costUsdt')

                function updateCost(){
                    const val = parseFloat(amountInput.value) || 0
                    const usdt = (val / RATE) * (1 + COMMISSION/100)
                    costEl.textContent = usdt.toFixed(2)
                }

                amountInput.addEventListener('input', updateCost)

                // send structured data back to bot
                document.getElementById('sendBtn').onclick = function(){
                    const amt = parseFloat(amountInput.value)
                    if(!amt || amt <= 0){ setStatus('Введите корректную сумму в рублях.'); return }
                    const payload = { qr: text, amount_rub: amt, merchant: document.getElementById('merchant').textContent }
                    try{ const tg = getTelegram(); tg.sendData(JSON.stringify(payload)); setStatus('Данные отправлены боту. Ожидайте подтверждения.'); }catch(e){ setStatus('Ошибка отправки данных в бот.'); }
                }

                document.getElementById('cancelBtn').onclick = function(){
                    document.getElementById('afterScan').style.display = 'none'
                    setStatus('Сканирование отменено.')
                }
            }

        // wire button
        scanBtn.addEventListener('click', startScan)

        // init
        (function(){
            const tg = getTelegram();
            if(!tg){ setStatus('Примечание: Для полноценной работы откройте эту страницу внутри Telegram (Web App).') }
            else{ try{ tg.ready() }catch(e){} setStatus('Нажмите «Отсканировать QR» чтобы начать.') }
        })();
    </script>
</body>
</html>


