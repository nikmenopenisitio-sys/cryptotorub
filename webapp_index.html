<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>CryptoToRub — Кошелек</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#07101a;--card:#0d1622;--muted:#9aa4b2;--accent:#2ca0ff;--glass:rgba(255,255,255,0.03)}
        html,body{height:100%;margin:0;font-family:Inter,system-ui,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,var(--bg),#08121a);color:#eaf3fb}
        .app{display:flex;flex-direction:column;height:100vh}

        header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
        .brand{display:flex;align-items:center;gap:12px}
        .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#2ca0ff,#1f6fd0);display:flex;align-items:center;justify-content:center;font-weight:700;color:#04212a}
        .title{font-weight:700}
        .subtitle{font-size:12px;color:var(--muted)}

        .content{flex:1;overflow:auto;padding:12px}

        /* Balance card */
        .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
        .balance-row{display:flex;align-items:center;justify-content:space-between}
        .balance-amount{font-size:28px;font-weight:800}
        .balance-small{color:var(--muted);font-size:13px}

    .actions{display:block;margin-top:12px}
    .btn{display:block;width:100%;padding:12px 18px;border-radius:12px;background:var(--glass);color:#eaf3fb;border:1px solid rgba(255,255,255,0.03);text-align:center;font-weight:700}
        .btn.primary{background:linear-gradient(90deg,var(--accent),#2ec1ff);color:#062d27;border:none}

        /* Quick summary */
        .summary{display:flex;gap:12px;margin-top:10px}
        .summary .item{flex:1;background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;text-align:center}
        .summary .value{font-weight:700}

        /* Transactions */
        .tx-list{margin-top:12px}
        .tx-item{display:flex;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:8px}
        .tx-item .meta{color:var(--muted);font-size:13px}

        /* Send modal */
        .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(1,4,8,0.6),rgba(1,4,8,0.6));z-index:60}
        .modal .panel{width:92%;max-width:420px;background:var(--card);padding:14px;border-radius:12px}
        .field{margin-bottom:10px}
        .field input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf3fb}
        .row{display:flex;gap:8px}

        .hint{font-size:12px;color:var(--muted);margin-top:8px}

        @media (min-width:900px){.content{max-width:720px;margin:0 auto}}
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="brand">
                <div class="logo">CT</div>
                <div>
                    <div class="title">CryptoToRub</div>
                    <div class="subtitle">USDT → RUB</div>
                </div>
            </div>
            <div style="text-align:right">
                <div class="balance-small">Курс: <span id="rateTxt">—</span></div>
                <div class="balance-small">Комиссия: <span id="commissionTxt">—</span></div>
            </div>
        </header>

        <div class="content">
            <div class="card">
                <div class="balance-row">
                    <div>
                        <div class="balance-amount" id="balanceAmount">— ₽</div>
                        <div class="balance-small">Баланс (оценка в RUB)</div>
                    </div>
                    <div style="text-align:right">
                        <div class="balance-small">Баланс USDT</div>
                        <div class="balance-small" id="balanceUsdt">—</div>
                    </div>
                </div>

                        <div class="actions">
                            <button class="btn primary" id="scanBtnSmall">Скан</button>
                        </div>

                <div class="summary">
                    <div class="item"><div class="value" id="todayAmt">—</div><div class="balance-small">Сегодня</div></div>
                    <div class="item"><div class="value" id="weekAmt">—</div><div class="balance-small">За неделю</div></div>
                </div>
            </div>

            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
                <div style="font-weight:700">Последние транзакции</div>
                <div style="color:var(--muted);font-size:13px">Показано: <span id="txCount">0</span></div>
            </div>

                    <div class="tx-list" id="txList"></div>

                    <div class="hint">Откройте внутри Telegram для быстрого сканирования QR-кодов.</div>
        </div>
    </div>
  

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Safe Telegram accessor
        function getTelegram(){ return (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null }

        const params = Object.fromEntries(new URLSearchParams(location.search));
        const parseHistory = (b64)=>{ try{ return JSON.parse(atob(b64)) }catch(e){return []} }

    // Elements
    const rateTxt = document.getElementById('rateTxt');
    const commissionTxt = document.getElementById('commissionTxt');
    const balanceAmount = document.getElementById('balanceAmount');
    const balanceUsdt = document.getElementById('balanceUsdt');
    const txList = document.getElementById('txList');
    const txCount = document.getElementById('txCount');
    const scanBtnSmall = document.getElementById('scanBtnSmall');

        // Apply params
        const RATE = params.rate ? Number(params.rate) : null;
        const COMMISSION = params.commission ? Number(params.commission) : 0;
        const BALANCE = params.balance ? Number(params.balance) : null;

        if(RATE) rateTxt.textContent = RATE + ' ₽/USDT'; else rateTxt.textContent = '—';
        commissionTxt.textContent = COMMISSION ? COMMISSION + ' %' : '—';
        if(BALANCE!==null){ balanceUsdt.textContent = BALANCE.toFixed(2) + ' USDT'; const rub = RATE? (BALANCE*RATE).toFixed(2) : '—'; balanceAmount.textContent = rub + ' ₽' }

        // Render history/transactions
        let history = [];
        if(params.history){ history = parseHistory(params.history)||[] }
        function renderTx(){ txList.innerHTML=''; history.slice(0,20).forEach(it=>{
            const el = document.createElement('div'); el.className='tx-item';
            const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${it.type}</div><div class="meta">${it.meta?.merchant||''}</div>`;
            const right = document.createElement('div'); right.innerHTML = `<div style="font-weight:700">${it.amount?it.amount+' ₽':''}</div><div class="meta">${new Date(it.ts||Date.now()).toLocaleString()}</div>`;
            el.appendChild(left); el.appendChild(right); txList.appendChild(el);
        }); txCount.textContent = history.length }
        renderTx();

        // Small scan button opens Telegram scanner if available
        scanBtnSmall.addEventListener('click', async ()=>{
            const tg = getTelegram();
            if(!tg){
                // Fallback: allow manual paste when not in Telegram
                const manual = prompt('Сканер доступен только внутри Telegram. Вставьте текст QR вручную:');
                if(manual){
                    try{ navigator.clipboard.writeText(manual).catch(()=>{}); alert('Вставлено в буфер.'); }
                    catch(e){}
                }
                return
            }

            try{
                let result = null;

                // Try Promise-based API first
                if(typeof tg.showScanQrPopup === 'function'){
                    try{
                        // some Telegram clients return a promise-resolving object { data }
                        result = await tg.showScanQrPopup();
                    }catch(errPromise){
                        // promise rejected or not supported in this client — try callback style
                        try{
                            result = await new Promise((resolve)=>{
                                try{
                                    tg.showScanQrPopup({ text: 'Наведите камеру на QR' }, function(data){ resolve({ data }); });
                                }catch(errCb){ resolve(null); }
                            });
                        }catch(e){ result = null }
                    }
                }

                // If still no result, try older callback-only signature
                if(!result){
                    try{
                        result = await new Promise((resolve)=>{
                            try{
                                tg.showScanQrPopup({ text: 'Наведите камеру на QR' }, function(data){ resolve({ data }); });
                            }catch(e){ resolve(null) }
                        });
                    }catch(e){ result = null }
                }

                if(result && result.data){
                    try{
                        tg.sendData(JSON.stringify({ type: 'scanned', data: result.data }));
                        alert('Отсканировано и отправлено боту');
                    }catch(e){ console.error('sendData failed', e); alert('Отсканировано, но не удалось отправить боту'); }
                }else{
                    // No data from scanner — ask to paste
                    const manual = prompt('Сканер не вернул данных. Вставьте текст QR вручную:');
                    if(manual){ try{ tg.sendData(JSON.stringify({ type:'scanned', data: manual })); alert('Вставлено и отправлено боту'); }catch(e){ alert('Не удалось отправить боту'); } }
                }
            }catch(e){ console.error('scan handler failed', e); alert('Ошибка при попытке сканирования: '+(e && e.message ? e.message : e)); }
        })

        // If opened inside Telegram, call ready/expand
        (function(){ const tg = getTelegram(); if(tg){ try{ tg.expand(); tg.ready(); }catch(e){} } })();
    </script>
</body>
</html>


