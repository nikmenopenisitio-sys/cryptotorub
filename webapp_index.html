<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>CryptoToRub ‚Äî –ö–æ—à–µ–ª–µ–∫</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#07101a;--card:#0d1622;--muted:#9aa4b2;--accent:#2ca0ff;--glass:rgba(255,255,255,0.03)}
        html,body{height:100%;margin:0;font-family:Inter,system-ui,'Segoe UI',Roboto,Arial;background:linear-gradient(180deg,var(--bg),#08121a);color:#eaf3fb}
        .app{display:flex;flex-direction:column;height:100vh}

        header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
        .brand{display:flex;align-items:center;gap:12px}
        .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#2ca0ff,#1f6fd0);display:flex;align-items:center;justify-content:center;font-weight:700;color:#04212a}
        .title{font-weight:700}
        .subtitle{font-size:12px;color:var(--muted)}

        .content{flex:1;overflow:auto;padding:12px}

        /* Balance card */
        .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
        .balance-row{display:flex;align-items:center;justify-content:space-between}
        .balance-amount{font-size:28px;font-weight:800}
        .balance-small{color:var(--muted);font-size:13px}

    .actions{display:block;margin-top:12px}
    .btn{display:block;width:100%;padding:12px 18px;border-radius:12px;background:var(--glass);color:#eaf3fb;border:1px solid rgba(255,255,255,0.03);text-align:center;font-weight:700}
        .btn.primary{background:linear-gradient(90deg,var(--accent),#2ec1ff);color:#062d27;border:none}

        /* Quick summary */
        .summary{display:flex;gap:12px;margin-top:10px}
        .summary .item{flex:1;background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;text-align:center}
        .summary .value{font-weight:700}

        /* Transactions */
        .tx-list{margin-top:12px}
        .tx-item{display:flex;justify-content:space-between;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);margin-bottom:8px}
        .tx-item .meta{color:var(--muted);font-size:13px}

        /* Send modal */
        .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(1,4,8,0.6),rgba(1,4,8,0.6));z-index:60}
        .modal .panel{width:92%;max-width:420px;background:var(--card);padding:14px;border-radius:12px}
        .field{margin-bottom:10px}
        .field input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf3fb}
        .row{display:flex;gap:8px}

        /* Bottom sheet for payment confirmation */
        .bottom-sheet{position:fixed;bottom:0;left:0;right:0;display:none;flex-direction:column;background:var(--card);border-radius:24px 24px 0 0;box-shadow:0 -10px 40px rgba(0,0,0,0.8);z-index:70;max-height:50vh;touch-action:none;animation:slideUp 0.3s ease-out}
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .bottom-sheet.hidden { animation:slideDown 0.3s ease-in; }
        @keyframes slideDown { from{transform:translateY(0)} to{transform:translateY(100%)} }
        .bs-handle{width:40px;height:4px;background:rgba(255,255,255,0.3);border-radius:2px;margin:12px auto;cursor:grab;touch-action:none}
        .bs-content{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
        .bs-header{font-size:16px;font-weight:700;color:#eaf3fb}
        .bs-info{font-size:13px;color:var(--muted);line-height:1.5}
        .bs-footer{padding:16px;display:flex;flex-direction:column;gap:8px;border-top:1px solid rgba(255,255,255,0.02)}
        .bs-amount{font-size:20px;font-weight:700;color:#eaf3fb;text-align:center}

        .hint{font-size:12px;color:var(--muted);margin-top:8px}

        @media (min-width:900px){.content{max-width:720px;margin:0 auto}}
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="brand">
                <div class="logo">CT</div>
                <div>
                    <div class="title">CryptoToRub</div>
                    <div class="subtitle">USDT ‚Üí RUB</div>
                </div>
            </div>
            <div style="text-align:right">
                <div class="balance-small">–ö—É—Ä—Å: <span id="rateTxt">‚Äî</span></div>
                <div class="balance-small">–ö–æ–º–∏—Å—Å–∏—è: <span id="commissionTxt">‚Äî</span></div>
            </div>
        </header>

        <div class="content">
            <div class="card">
                <div class="balance-row">
                    <div>
                        <div class="balance-amount" id="balanceAmount">‚Äî ‚ÇΩ</div>
                <div class="balance-small">–ë–∞–ª–∞–Ω—Å (–æ—Ü–µ–Ω–∫–∞)</div>
                    </div>
                    <div style="text-align:right">
                <div class="balance-small">–ü–æ–∫–∞–∑–∞—Ç—å –≤:</div>
                <select id="currencySelect" style="margin-top:6px;padding:6px;border-radius:8px;background:transparent;color:#eaf3fb;border:1px solid rgba(255,255,255,0.04)">
                    <option value="USD">USD</option>
                    <option value="RUB">RUB</option>
                    <option value="EUR">EUR</option>
                </select>
                <div class="balance-small" style="margin-top:8px">–ë–∞–ª–∞–Ω—Å USDT</div>
                <div class="balance-small" id="balanceUsdt">‚Äî</div>
                    </div>
                </div>

                        <div class="actions">
                            <button class="btn primary" id="scanBtnSmall">–°–∫–∞–Ω</button>
                        </div>

                <div class="summary">
                    <div class="item"><div class="value" id="todayAmt">‚Äî</div><div class="balance-small">–°–µ–≥–æ–¥–Ω—è</div></div>
                    <div class="item"><div class="value" id="weekAmt">‚Äî</div><div class="balance-small">–ó–∞ –Ω–µ–¥–µ–ª—é</div></div>
                </div>
            </div>

            <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
                <div style="font-weight:700">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                <div style="color:var(--muted);font-size:13px">–ü–æ–∫–∞–∑–∞–Ω–æ: <span id="txCount">0</span></div>
            </div>

                    <div class="tx-list" id="txList"></div>

                    <div class="hint">–û—Ç–∫—Ä–æ–π—Ç–µ –≤–Ω—É—Ç—Ä–∏ Telegram –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–æ–≤.</div>
        </div>
    </div>
  

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Safe Telegram accessor
        function getTelegram(){ return (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null }

        const params = Object.fromEntries(new URLSearchParams(location.search));
        // robust base64 url-safe decoder -> JSON
        const parseHistory = (b64)=>{
            try{
                // some encoders use urlsafe base64 ( - and _ ). Convert to standard base64
                let s = b64.replace(/-/g,'+').replace(/_/g,'/');
                // pad
                while(s.length % 4) s += '=';
                return JSON.parse(atob(s));
            }catch(e){
                try{ return JSON.parse(atob(b64)) }catch(e2){ return [] }
            }
        }

    // Elements
    const rateTxt = document.getElementById('rateTxt');
    const commissionTxt = document.getElementById('commissionTxt');
    const balanceAmount = document.getElementById('balanceAmount');
    const balanceUsdt = document.getElementById('balanceUsdt');
    const txList = document.getElementById('txList');
    const txCount = document.getElementById('txCount');
    const scanBtnSmall = document.getElementById('scanBtnSmall');

        // Apply params and currency conversion support
        const RATE = params.rate ? Number(params.rate) : null; // RUB per USDT
        const COMMISSION = params.commission ? Number(params.commission) : 0;
        let BALANCE = params.balance ? Number(params.balance) : null; // in USDT

        if(RATE) rateTxt.textContent = RATE + ' ‚ÇΩ/USDT'; else rateTxt.textContent = '‚Äî';
        commissionTxt.textContent = COMMISSION ? COMMISSION + ' %' : '‚Äî';

        // History
        let history = [];
        if(params.history){ history = parseHistory(params.history)||[] }

        // If balance wasn't provided or is NaN, try to compute from history (sum of amounts)
        if((BALANCE === null || Number.isNaN(BALANCE)) && history && history.length){
            try{ const sum = history.reduce((acc,it)=> acc + (Number(it.amount)||0), 0); BALANCE = Number(sum); }catch(e){ BALANCE = null }
        }

        // Currency conversion state
        const currencySelect = document.getElementById('currencySelect');
        let displayCurrency = localStorage.getItem('currency') || 'RUB';
        if(currencySelect) currencySelect.value = displayCurrency;

        // rates: usd->RUB, usd->EUR
        let usdToRub = RATE || null;
        let usdToEur = null;

        async function fetchRates(){
            try{
                const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=RUB,EUR');
                if(res.ok){
                    const j = await res.json();
                    if(j && j.rates){ usdToRub = j.rates.RUB || usdToRub; usdToEur = j.rates.EUR || usdToEur; }
                }
            }catch(e){
                // ignore ‚Äî we'll use fallback values
            }
            // sensible defaults if still null
            if(usdToRub === null && RATE) usdToRub = RATE;
            if(usdToEur === null) usdToEur = 0.9; // approximate
        }

        function convertUSDT(u, cur){
            const v = Number(u) || 0;
            if(cur === 'USD') return v;
            if(cur === 'RUB') return (usdToRub != null) ? v * usdToRub : null;
            if(cur === 'EUR') return (usdToEur != null) ? v * usdToEur : null;
            return null;
        }

        function formatCurrency(val, cur){
            if(val === null || typeof val === 'undefined' || Number.isNaN(val)) return '‚Äî';
            if(cur === 'USD') return val.toFixed(2) + ' USD';
            if(cur === 'EUR') return val.toFixed(2) + ' EUR';
            if(cur === 'RUB') return Number(val).toFixed(2) + ' ‚ÇΩ';
            return val.toFixed(2) + ' ' + cur;
        }

        function renderTx(){
            txList.innerHTML='';
            history.slice(0,20).forEach(it=>{
                const el = document.createElement('div'); el.className='tx-item';
                const left = document.createElement('div');
                const title = (it.type || '').toString();
                const merchant = (it.meta && it.meta.merchant) ? it.meta.merchant : '';
                left.innerHTML = `<div style="font-weight:700">${title}</div><div class="meta">${merchant}</div>`;

                const right = document.createElement('div');
                const amtUSDT = Number(it.amount)||0;
                const conv = convertUSDT(amtUSDT, displayCurrency);
                const convText = conv !== null ? formatCurrency(Math.abs(conv), displayCurrency) : '‚Äî';
                const sign = amtUSDT>0?'+':'-';
                const usdtText = `${sign}${Math.abs(amtUSDT).toFixed(4)} USDT`;
                const timeText = new Date(it.ts||Date.now()).toLocaleString();
                right.innerHTML = `<div style="font-weight:700">${sign}${convText}</div><div class="meta">${usdtText} ‚Ä¢ ${timeText}</div>`;

                el.appendChild(left); el.appendChild(right); txList.appendChild(el);
            });
            txCount.textContent = history.length || 0;
        }

        // initial rates fetch and render
        (async ()=>{ await fetchRates(); renderTx(); updateBalanceDisplay(); })();

        function updateBalanceDisplay(){
            if(BALANCE!==null && !Number.isNaN(BALANCE)){
                balanceUsdt.textContent = BALANCE.toFixed(4) + ' USDT';
                const conv = convertUSDT(BALANCE, displayCurrency);
                balanceAmount.textContent = conv !== null ? formatCurrency(conv, displayCurrency) : '‚Äî';
            } else {
                balanceUsdt.textContent = '‚Äî';
                balanceAmount.textContent = '‚Äî';
            }
        }

        if(currencySelect){
            currencySelect.addEventListener('change', ()=>{
                displayCurrency = currencySelect.value;
                localStorage.setItem('currency', displayCurrency);
                renderTx();
                updateBalanceDisplay();
            });
        }

        // Small scan button opens Telegram scanner if available
        scanBtnSmall.addEventListener('click', async ()=>{
            const tg = getTelegram();
            if(!tg){
                // Fallback: allow manual paste when not in Telegram
                const manual = prompt('–°–∫–∞–Ω–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç QR –≤—Ä—É—á–Ω—É—é:');
                if(manual){
                    try{ navigator.clipboard.writeText(manual).catch(()=>{}); alert('–í—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –±—É—Ñ–µ—Ä.'); }
                    catch(e){}
                }
                return
            }

            try{
                let result = null;
                // Quick diagnostic: if Telegram exists but doesn't expose showScanQrPopup,
                // inform the user (desktop/web clients often don't support the scanner).
                if(typeof tg.showScanQrPopup !== 'function'){
                    alert('–í–∞—à –∫–ª–∏–µ–Ω—Ç Telegram –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä QR (showScanQrPopup).\n–û—Ç–∫—Ä–æ–π—Ç–µ Web App –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Telegram –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç–∞–≤–∫—É —Ç–µ–∫—Å—Ç–∞.');
                    return;
                }

                // Try Promise-based API first
                if(typeof tg.showScanQrPopup === 'function'){
                    try{
                        // some Telegram clients return a promise-resolving object { data }
                        result = await tg.showScanQrPopup();
                    }catch(errPromise){
                        // promise rejected or not supported in this client ‚Äî try callback style
                        try{
                            result = await new Promise((resolve)=>{
                                try{
                                    tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR' }, function(data){ resolve({ data }); });
                                }catch(errCb){ resolve(null); }
                            });
                        }catch(e){ result = null }
                    }
                }

                // If still no result, try older callback-only signature
                if(!result){
                    try{
                        result = await new Promise((resolve)=>{
                            try{
                                tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR' }, function(data){ resolve({ data }); });
                            }catch(e){ resolve(null) }
                        });
                    }catch(e){ result = null }
                }

                if(result && result.data){
                    try{
                        // try to extract amount and currency from common QR formats
                        const detected = extractAmountFromQr(result.data);
                        // show payment bottom sheet so user can confirm and see conversions
                        showPaymentSheet({ qr: result.data, detected });
                    }catch(e){ console.error('scan handling failed', e); alert('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'); }
                }else{
                    // No data from scanner ‚Äî ask to paste
                            const manual = prompt('–°–∫–∞–Ω–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã—Ö. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç QR –≤—Ä—É—á–Ω—É—é:');
                            if(manual){
                                try{
                                    const detected = extractAmountFromQr(manual);
                                    showPaymentSheet({ qr: manual, detected });
                                }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å QR'); }
                            }
                }
            }catch(e){ console.error('scan handler failed', e); alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: '+(e && e.message ? e.message : e)); }
        })

                // Attempt to find an amount and currency inside a scanned QR string
                // IMPORTANT: SBP/NSPK QRs are always in RUB (Russian banking standard)
                // Only treat as USD if there's EXPLICIT $ or "USD" marker near the number
                function extractAmountFromQr(qr){
                    if(!qr || typeof qr !== 'string') return { amount: null, currency: null };
                    let amount = null; let currency = null;

                    // 1) Check if this is an SBP/NSPK QR (these are ALWAYS RUB)
                    const isSBP = /qr\.nspk\.ru|nspk|sbp/.test((qr||'').toLowerCase());

                    // 2) If it's a URL, inspect search params
                    try{
                        const u = new URL(qr);
                        const params = u.searchParams;
                        const preferKeys = ['amount_rub','sum_rub','amount_usd','sum_usd','amount','sum','total','s'];
                        for(const k of preferKeys){
                            if(params.has(k)){
                                const raw = params.get(k);
                                const v = (raw||'').replace(',', '.').replace(/[^0-9.]/g,'');
                                const n = parseFloat(v);
                                if(!isNaN(n)){
                                    amount = n;
                                    if(k.includes('rub')) currency='RUB';
                                    else if(k.includes('usd')) currency='USD';
                                    break;
                                }
                            }
                        }

                        // If SBP, force RUB regardless
                        if(isSBP) currency = 'RUB';
                    }catch(e){ /* not a URL ‚Äî continue */ }

                    // 3) Try to find explicit number with currency nearby (STRONG signal only)
                    if(amount === null || !currency){
                        // patterns: "‚ÇΩ" "RUB" are ALWAYS RUB; "$" is ALWAYS USD; generic "500" defaults to RUB if SBP
                        const patterns = [
                            {re:/([0-9]+[.,]?[0-9]*)\s*(?:‚ÇΩ|RUB|RUR|—Ä—É–±)\b/i, cur:'RUB'},
                            {re:/\$\s*([0-9]+[.,]?[0-9]*)/i, cur:'USD'},
                            {re:/([0-9]+[.,]?[0-9]*)\s*USD\b/i, cur:'USD'},
                            {re:/([0-9]+[.,]?[0-9]*)\s*(?:EUR|‚Ç¨)\b/i, cur:'EUR'},
                        ];
                        for(const p of patterns){
                            const m = qr.match(p.re);
                            if(m && m[1]){ 
                                if(amount === null) amount = parseFloat(m[1].replace(',', '.'));
                                if(!currency) currency = p.cur;
                                break;
                            }
                        }
                    }

                    // 4) If still no amount, look for first numeric token
                    if(amount === null){
                        const weak = qr.match(/([0-9]+[.,]?[0-9]*)/g);
                        if(weak && weak.length){
                            amount = parseFloat(weak[0].replace(',', '.'));
                        }
                    }

                    // 5) Final currency decision: if SBP or still no clear signal, use RUB
                    if(!currency){
                        if(isSBP) currency = 'RUB';
                        else currency = 'RUB'; // default to RUB to avoid accidental USD charges
                    }

                    return { amount: amount, currency: currency };
                }

                // --- Bottom sheet for payment confirmation ---
                (function(){
                    const sheet = document.createElement('div');
                    sheet.className='bottom-sheet';
                    sheet.id='paySheet';
                    sheet.innerHTML = `
                        <div class="bs-handle" id="bs_handle"></div>
                        <div class="bs-content">
                            <div class="bs-header">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞</div>
                            <div id="bs_detail" class="bs-info"></div>
                            <div id="bs_info" class="bs-info"></div>
                        </div>
                        <div class="bs-footer">
                            <button id="pm_pay" class="btn primary" style="font-size:16px;padding:16px">üí≥ –û–ü–õ–ê–¢–ò–¢–¨</button>
                            <button id="pm_cancel" class="btn" style="font-size:14px">–û—Ç–º–µ–Ω–∞</button>
                        </div>`;
                    document.body.appendChild(sheet);

                    // Swipe-down to close
                    let touchStartY = 0;
                    const handle = document.getElementById('bs_handle');
                    handle.addEventListener('touchstart', (e)=>{ touchStartY = e.touches[0].clientY; });
                    handle.addEventListener('touchmove', (e)=>{
                        const diff = e.touches[0].clientY - touchStartY;
                        if(diff > 60){ hidePaymentSheet(); }
                    });
                })();

                function showPaymentSheet({qr, detected}){
                    const sheet = document.getElementById('paySheet');
                    if(!sheet) return;

                    const detail = document.getElementById('bs_detail');
                    const info = document.getElementById('bs_info');
                    const payBtn = document.getElementById('pm_pay');
                    const cancelBtn = document.getElementById('pm_cancel');

                    let amount = detected && detected.amount ? Number(detected.amount) : null;
                    let currency = detected && detected.currency ? detected.currency : null;

                    if(amount === null){
                        detail.textContent = '–°—É–º–º–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –≤ QR.';
                        info.textContent = '';
                    } else {
                        // Compute converted amounts
                        let amount_rub = null;
                        if(currency === 'RUB') amount_rub = amount;
                        else if(currency === 'USD') amount_rub = (usdToRub != null) ? amount * usdToRub : null;
                        else if(currency === 'EUR') amount_rub = (usdToEur != null && usdToRub!=null) ? (amount / usdToEur) * usdToRub : null;
                        else amount_rub = amount;

                        const amount_usd = (usdToRub && amount_rub!=null) ? (amount_rub / usdToRub) : null;
                        let usdt_needed = null;
                        if(RATE && amount_rub!=null) usdt_needed = (amount_rub / RATE) * (1 + (COMMISSION||0)/100);

                        detail.innerHTML = `<div class="bs-amount">${amount.toFixed(2)} ${currency}</div><br>`+
                                           `–í —Ä—É–±–ª—è—Ö: <b>${amount_rub!==null?amount_rub.toFixed(2)+' ‚ÇΩ':'‚Äî'}</b><br>`+
                                           `–í –¥–æ–ª–ª–∞—Ä–∞—Ö: <b>${amount_usd!==null?amount_usd.toFixed(2)+' USD':'‚Äî'}</b>`;

                        info.innerHTML = `<b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> ${BALANCE!==null?BALANCE.toFixed(4)+' USDT':'‚Äî'}<br>`+
                                         `<b>–ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è (‚âà):</b> ${usdt_needed!==null?usdt_needed.toFixed(4)+' USDT':'‚Äî'}<br>`+
                                         `<b>–ö—É—Ä—Å:</b> ${RATE?RATE+' ‚ÇΩ/USDT':'‚Äî'}<br>`+
                                         `<b>–ö–æ–º–∏—Å—Å–∏—è:</b> ${COMMISSION?COMMISSION+'%':'‚Äî'}`;
                    }

                    sheet.style.display = 'flex';

                    // Remove old listeners
                    payBtn.onclick = null;
                    cancelBtn.onclick = null;

                    function doSend(){
                        const tg = getTelegram();
                        if(!tg){ alert('–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.'); return; }
                        const payload = { type:'scanned', data: qr };

                        if(amount !== null && currency){
                            if(currency === 'RUB') payload.amount_rub = Number(amount);
                            else if(currency === 'USD' && usdToRub) payload.amount_rub = Number((amount * usdToRub).toFixed(2));
                            else if(currency === 'EUR' && usdToEur && usdToRub) payload.amount_rub = Number(((amount / usdToEur) * usdToRub).toFixed(2));
                        }

                        try{ tg.sendData(JSON.stringify(payload)); hidePaymentSheet(); alert('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É'); }
                        catch(e){ console.error('sendData failed', e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É'); }
                    }

                    payBtn.onclick = doSend;
                    cancelBtn.onclick = hidePaymentSheet;
                }

                function hidePaymentSheet(){
                    const sheet = document.getElementById('paySheet');
                    if(sheet) sheet.style.display = 'none';
                }

        // If opened inside Telegram, call ready/expand
        (function(){ const tg = getTelegram(); if(tg){ try{ tg.expand(); tg.ready(); }catch(e){} } })();
    </script>
</body>
</html>


